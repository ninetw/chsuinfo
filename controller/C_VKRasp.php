<?phpinclude_once('controller/C_Base.php');//// Конттроллер страницы подписки на смс рассылку и расслку в ВКонтакте//class C_VKRasp extends C_Base {		protected $mSmsRasp;	private $msg = null;	private $err = 1;	//    // Конструктор.    //    function __construct()     {    	parent::__construct();    	//$this->needLogin = true; // раскомментируйте, чтобы закрыть неавторизованный доступ к странице        $this->mSmsRasp= M_SmsRasp::Instance();		$this->mRasp = M_Rasp::Instance();    }    //    // Виртуальный обработчик запроса.    //    protected function OnInput(){		// C_Base.		parent::OnInput();						// Обработка отправки формы.		if ($this->IsPost())		{			//Зносим данные в переменные						$time=$_POST[time];			$notification = $_POST['notification'];														if (isset($notification))			{				$notification=1;			}			else			{				$notification=0;			}						if (!($this->user))			{				$this->msg="<div class=\"alert alert-danger fade in\" role=\"alert\">			  <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button>Если вы желаете оформить подписку, войдите на сайт.</div>";				return;			};						if(isset($_POST[vk]))			{								//Проверяем имеет ли пользователь VK подписку				if ($this->mSmsRasp->verVKMailing($this->user))				{						$this->msg="<div class=\"alert alert-danger fade in\" role=\"alert\">			  <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button>У вас уже оформлена VK рассылка расписания.</div>";					return;				};								//Добавляем пользователя в базу				$vars = array(							'id_user'=>$this->user[id_user],							'message_type'=>"vk",							'time'=>$time,							'notification'=>$notification,							'mailing_start'=>date('Y-m-d'),							'mailing_end'=>date('Y-m-d',mktime(0, 0, 0, date("m"), date("d")+$count_day, date("Y")))							);				$this->mSmsRasp->add_mailing($vars);				$this->err=0;				$this->msg="<div class=\"alert alert-success fade in\" role=\"alert\">			  <button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button>Подписка успешно оформлена! Сообщения будут приходить пользователю <b><a href='http://vk.com/id".$this->user[id_vk]."'>http://vk.com/id".$this->user[id_vk]."</a></b></div>";			}		}						if ($this->IsGet())		{			if((isset($_GET[id_mailing]))&&($_GET[mailing]=='delete'))			{				$this->mSmsRasp->delMailing($_GET[id_mailing],$this->user[id_user]);				header('Location:http://'.$_SERVER['HTTP_HOST'].'/');			}						}    }    //    // Виртуальный генератор HTML.    //    protected function OnOutput() {		$masVK=$this->mSmsRasp->verVKMailing($this->user);		$masSMS=$this->mSmsRasp->verSMSMailing($this->user);		if(count($masVK)!=0){			$vk=$masVK[0];		}				if(count($masSMS)!=0){			 $sms=$masSMS[0];		}				$returnMsg = array('vk_mailing'=>$vk[id_mailing],'err'=>$this->err,'html'=>$this->msg);		$returnMsg = json_encode($returnMsg);        // Генерация содержимого страницы.    	$vars = array(						'user' => $this->user,					'grup'=>$this->mRasp->all_grup(),					'lecturer'=>$this->mRasp->all_lecturer(),					'alertOk'=>$this->alertOk,					'alertFail'=>$this->alertFail,					'alertNotif'=>$this->alertNotif,					'person'=>$this->user[person],					'sms'=>$sms,					'vk'=>$vk,					'jsonResponse'=>$returnMsg);	    	    	echo $returnMsg;	}}