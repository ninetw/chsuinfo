<?phpinclude_once('controller/C_Base.php');//// Конттроллер страницы подписки на смс рассылку и расслку в ВКонтакте//class C_VKSmsRasp extends C_Base {		protected $mSmsRasp;	//    // Конструктор.    //    function __construct()     {    	parent::__construct();    	//$this->needLogin = true; // раскомментируйте, чтобы закрыть неавторизованный доступ к странице        $this->mSmsRasp= M_SmsRasp::Instance();		$this->mRasp = M_Rasp::Instance();    }    //    // Виртуальный обработчик запроса.    //    protected function OnInput(){		// C_Base.		parent::OnInput();						// Обработка отправки формы.		if ($this->IsPost())		{			//Зносим данные в переменные						$time=$_POST[time];			$count_day=$_POST[count_day];			$notification = $_POST['notification'];														if (isset($notification))			{				$notification=1;			}			else			{				$notification=0;			}						if (!($this->user))			{				$this->alertNotif="Если вы желаете оформить подписку, войдите на сайт.";				return;			};						if (!($this->user[person]))			{				$this->alertFail='Для оформления SMS подписки укажите в <a href="index.php?c=setting">настройках профиля</a> группу в которой вы обучаетесь, преподавателям же необходимо выбрать себя из списка.';				return;			};										if(isset($_POST[sms]))			{						//Проверяем указанна ли у пользователя группа				if ($this->user[person]=='')				{					$this->alertFail="Укажите в настройках профиля группу или имя если вы преподаватель.";					return;				};												//Проверяем имеет ли пользователь SMS подписку				if ($this->mSmsRasp->verSmsMailing($this->user))				{					$this->alertFail="У вас уже оформлена SMS рассылка расписания.";					return;				};							//Добавляем пользователя в базу				$vars = array('id_user'=>$this->user[id_user],							'message_type'=>"sms",							'time'=>$time,							'notification'=>$notification,							'mailing_start'=>date('Y-m-d'),							'mailing_end'=>date('Y-m-d',mktime(0, 0, 0, date("m"), date("d")+$count_day, date("Y")))							);				$this->mSmsRasp->add_mailing($vars);				$this->alertOk="Подписка успешно оформлена! Сообщения будут приходить на номер <b>".$this->user[phone_number]."</b>";			}			elseif(isset($_POST[vk]))			{				//Проверяем привязан ли акк вк				if ($this->user[id_vk]==0)				{					$this->alertFail="Для того, что бы получать сообщения с расписанием в \"ВКонтакте\", необходимо в настройках <a href='index.php?c=setting'>профиля</a> привязать аккаунт \"ВКонтакте\"";					return;				};								//Проверяем имеет ли пользователь VK подписку				if ($this->mSmsRasp->verVKMailing($this->user))				{					$this->alertFail="У вас уже оформлена VK рассылка расписания.";					return;				};								//Добавляем пользователя в базу				$vars = array(							'id_user'=>$this->user[id_user],							'message_type'=>"vk",							'time'=>$time,							'notification'=>$notification,							'mailing_start'=>date('Y-m-d'),							'mailing_end'=>date('Y-m-d',mktime(0, 0, 0, date("m"), date("d")+$count_day, date("Y")))							);				$this->mSmsRasp->add_mailing($vars);				$this->alertOk="Подписка успешно оформлена! Сообщения будут приходить пользователю <b><a href='http://vk.com/id".$this->user[id_vk]."'>http://vk.com/id".$this->user[id_vk]."</a></b>";			}		}															if ($this->IsGet())		{			if((isset($_GET[id_mailing]))&&($_GET[mailing]=='delete'))			{				$this->mSmsRasp->delMailing($_GET[id_mailing],$this->user[id_user]);				$this->alertOk="Вы отказались от рассылки расписания. Вы в любой момент сможете оформить подписку заново";			}						}    }    //    // Виртуальный генератор HTML.    //    protected function OnOutput() {			$masVK=$this->mSmsRasp->verVKMailing($this->user);		$masSMS=$this->mSmsRasp->verSMSMailing($this->user);		if(count($masVK)!=0)		{			$vk=$masVK[0];		}				if(count($masSMS)!=0)		{			 $sms=$masSMS[0];		}								        // Генерация содержимого страницы.    	$vars = array(						'user' => $this->user,					'grup'=>$this->mRasp->all_grup(),					'lecturer'=>$this->mRasp->all_lecturer(),					'alertOk'=>$this->alertOk,					'alertFail'=>$this->alertFail,					'alertNotif'=>$this->alertNotif,					'person'=>$this->user[person],					'sms'=>$sms,					'vk'=>$vk);	    	    	$this->content = $this->View(THEME.'/tpl_sms_vk_rasp.php', $vars);		// C_Base.        parent::OnOutput();    }}